<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">Generador de CV (ATS-Friendly)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5016816171104319"
         crossorigin="anonymous"></script>

    <style>
        :root {
            --primary-color: #0f172a; /* Azul oscuro serio */
            --primary-hover: #1e293b;
            --accent-color: #10b981; /* Verde esmeralda moderno */
            --bg-color: #f8fafc; /* Gris muy claro */
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-heading: #0f172a;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif; /* Cambio de fuente */
            background-color: var(--bg-color);
            padding: 40px 20px;
            color: var(--text-main);
            line-height: 1.6;
        }

        .container {
            max-width: 850px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 50px;
            border-radius: 12px; /* Bordes menos redondeados */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Sombra sutil */
            border: 1px solid var(--border-color);
        }

        h1 {
            font-weight: 700;
            color: var(--text-heading);
            margin-bottom: 10px;
            letter-spacing: -0.025em; /* Tracking moderno */
        }

        .subtitle {
            font-size: 1.1em;
            color: #64748b;
            margin-bottom: 40px;
            font-weight: 300;
        }

        /* MOBILE FIRST: Stack inputs vertically */
        .grid {
            display: block;
        }

        .grid>div {
            margin-bottom: 25px;
        }

        /* Estilos de Inputs */
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-heading);
            font-size: 0.95em;
        }

        .file-box {
            border: 2px dashed #cbd5e1;
            padding: 40px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f1f5f9;
        }

        .file-box:hover {
            border-color: var(--primary-color);
            background-color: #e2e8f0;
        }

        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95em;
            transition: border-color 0.2s;
            background-color: #fff;
        }
        
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
        }

        textarea {
            height: 160px;
            resize: vertical;
        }

        .annex-selector {
            margin-top: 25px;
            padding: 20px;
            background-color: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        button#combineBtn {
            width: 100%;
            padding: 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-top: 30px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        button#combineBtn:hover {
            background-color: var(--primary-hover);
        }
        
        button#combineBtn:active {
            transform: scale(0.99);
        }

        button#combineBtn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        /* BARRA DE PROGRESO (Minimalista) */
        .progress-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 100px;
            margin-top: 25px;
            height: 6px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            transition: width 0.5s ease-in-out;
            border-radius: 100px;
        }

        /* Contenedor de Idiomas */
        .language-selector {
            text-align: right; /* Alineado a la derecha para estilo moderno */
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .language-selector label {
            display: inline-block;
            margin-right: 10px;
            font-weight: 400;
            color: #64748b;
        }

        .language-selector button {
            background: white;
            border: 1px solid var(--border-color);
            cursor: pointer;
            padding: 6px 12px;
            margin-left: 5px;
            border-radius: 6px;
            transition: all 0.2s;
            opacity: 0.7;
            filter: grayscale(100%); /* Banderas en gris por defecto */
        }
        
        .language-selector button:hover {
            opacity: 1;
            filter: grayscale(0%);
        }

        /* Estado seleccionado */
        .language-selector button.selected {
            border-color: var(--primary-color);
            opacity: 1;
            filter: grayscale(0%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .language-selector img {
            width: 24px;
            vertical-align: middle;
        }


        #downloadArea {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            justify-content: center;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        #previewContainer {
            margin-top: 30px;
            background: #f1f5f9;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: 'Courier New', Courier, monospace; /* Estilo c√≥digo para preview */
            font-size: 0.9em;
            color: #333;
        }

        /* Desktop Grid */
        @media (min-width: 768px) {
            .grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }

            #downloadArea {
                flex-direction: row;
            }
        }

        /* Botones de Descarga */
        .btn-download {
            background-color: white;
            color: var(--text-heading);
            padding: 14px 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .btn-download:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: #f8fafc;
        }

        /* Bot√≥n de carta destacado ligeramente diferente */
        .btn-download-letter {
            border-color: transparent;
            background-color: #f1f5f9;
        }

    </style>
</head>

<body>

    <div class="container">
        
        <div class="language-selector">
            <label id="labelLangSelect">Idioma / Language:</label>
            <button id="lang-es" onclick="setLanguage('es')"><img src="https://flagcdn.com/w40/es.png" alt="Espa√±ol"></button>
            <button id="lang-en" onclick="setLanguage('en')" class="selected"><img src="https://flagcdn.com/w40/gb.png" alt="English"></button>
            <button id="lang-de" onclick="setLanguage('de')"><img src="https://flagcdn.com/w40/de.png" alt="Deutsch"></button>
            <button id="lang-pt" onclick="setLanguage('pt')"><img src="https://flagcdn.com/w40/pt.png" alt="Portugu√™s"></button>
        </div>

        <h1 id="mainTitle">Generador de CV</h1>
        <p class="subtitle" id="subTitle">Optimizaci√≥n ATS inteligente y fusi√≥n de documentos.</p>

        <div class="grid">
            <div>
                <label id="labelUpload">1. Tu CV Actual (PDF)</label>
                <div class="file-box" onclick="document.getElementById('pdfInput').click()">
                    <div style="font-size: 2em; margin-bottom: 10px;">üìÑ</div>
                    <span id="fileName" style="font-weight: 500;">Seleccionar archivo...</span>
                    <input type="file" id="pdfInput" accept=".pdf" style="display:none" onchange="mostrarNombre()">
                </div>
            </div>

            <div>
                <label id="labelJobDesc">2. Descripci√≥n de la Oferta</label>
                <textarea id="jobDescription" placeholder="Pega aqu√≠ el texto de la oferta de trabajo para adaptar tu perfil..."></textarea>
            </div>
        </div>

        <div class="annex-selector">
            <label for="annexStartPage" id="labelAnnexPage">3. Configuraci√≥n de Anexos</label>
            <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
                <span style="font-size: 0.9em;">Iniciar anexos en p√°gina:</span>
                <input type="number" id="annexStartPage" value="3" min="1" style="width: 80px;">
            </div>
            <small id="smallAnnexDesc" style="display:block; margin-top:8px; color: #64748b; font-size: 0.85em;">
                (Ej. Si tu nuevo CV ocupa 2 p√°ginas, los anexos del original se pegar√°n a partir de la 3).
            </small>
        </div>


        <button id="combineBtn" onclick="combinarDocumentos()">Generar y Adaptar CV</button>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <p id="status" style="text-align:center; margin-top:15px; color: #64748b; font-size: 0.9em; font-weight: 500;"></p>

        <div id="downloadArea" style="display: none;">
            <button class="btn-download" id="btnCVDownload" onclick="descargarCV()">
                <span>üì•</span> Descargar CV Optimizado
            </button>
            <button class="btn-download btn-download-letter" id="btnLetterDownload" onclick="descargarCartaPresentacion()">
                <span>üìù</span> Descargar Carta Presentaci√≥n
            </button>
        </div>

        <div id="previewContainer" style="display:none;"></div>

    </div>

    <script>
        // --- 0. CONFIGURACI√ìN GLOBAL Y TRADUCCIONES ---
        // ¬°IMPORTANTE!: Tu API Key est√° aqu√≠. Aseg√∫rate de que siga siendo la correcta.
        const API_KEY = "AIzaSyB4Ky_nw8MIxh7eT7z6Vfr_W6dY1eHaIVw"; 
        const MODELO = "gemini-2.5-flash";

        const { jsPDF } = window.jspdf;
        const { PDFDocument } = window.PDFLib;

        let finalCVData = null;
        let originalPdfBuffer = null;
        window.appLanguage = 'en';

        // DEFINICI√ìN DE M√ÅRGENES (mm)
        const LEFT_MARGIN = 20;

        const translations = {
            es: {
                // UI Strings
                TITLE: 'Generador de CV (ATS)',
                SUBTITLE: 'Optimizaci√≥n ATS inteligente y fusi√≥n de documentos.',
                LABEL_LANG_SELECT: 'Idioma:',
                LABEL_UPLOAD: '1. Tu CV Actual (PDF)',
                FILENAME_PLACEHOLDER: 'Seleccionar archivo...',
                LABEL_JOB_DESC: '2. Descripci√≥n de la Oferta',
                JOB_DESC_PLACEHOLDER: 'Pega aqu√≠ el texto de la oferta...',
                LABEL_ANNEX_PAGE: '3. Configuraci√≥n de Anexos',
                SMALL_ANNEX_DESC: '(Ej. Si tu nuevo CV ocupa 2 p√°ginas, los anexos se pegar√°n a partir de la 3).',
                BTN_COMBINE: 'GENERAR Y ADAPTAR CV',
                BTN_CV_DOWNLOAD: 'üì• Descargar CV Optimizado',
                BTN_LETTER_DOWNLOAD: 'üìù Descargar Carta Presentaci√≥n',
                STATUS_COMPLETE: 'Proceso finalizado. Tus documentos est√°n listos.',
                STATUS_INCOMPLETE: '‚ö†Ô∏è Por favor, sube tu CV y la descripci√≥n de la oferta.',
                STATUS_VALIDATE_PAGE: '‚ö†Ô∏è N√∫mero de p√°gina inv√°lido.',
                STATUS_READING: 'Analizando documento PDF...',
                STATUS_THINKING: 'La IA est√° redactando y optimizando tu perfil...',

                // PDF/AI Strings
                CV_TITLE: 'Lebenslauf (CV)',
                EXP_TITLE: 'EXPERIENCIA LABORAL',
                SKILLS_TITLE: 'HABILIDADES',
                EDU_TITLE: 'EDUCACI√ìN',
                PERSONAL_TITLE: 'DATOS PERSONALES',
                FIELD_CONTACTO: 'Contacto',
                FIELD_NACIONALIDAD: 'Nacionalidad',
                FIELD_ESTADO_CIVIL: 'Estado Civil',
                FIELD_FECHA_NACIMIENTO: 'Fecha de Nacimiento',
                FIELD_LUGAR_NACIMIENTO: 'Lugar de Nacimiento',
                FIELD_DIRECCION: 'Direcci√≥n',
                LETTER_SUBJECT: 'Postulaci√≥n para el puesto de',
                LETTER_CLOSING_SALUTATION: 'Atentamente,',
                LETTER_CLOSING_BODY: 'Agradezco su tiempo y dedicaci√≥n. Adjunto mi CV (Lebenslauf) para su exhaustiva revisi√≥n y espero con entusiasmo una oportunidad para conversar.',
                LETTER_GENERIC_SALUTATION: 'Estimado/a Director/a de Contrataci√≥n,',
                LETTER_GENERIC_TEAM: 'Equipo de Recursos Humanos de',
                COUNTRY_RESIDENCE: 'Pa√≠s de Residencia',
            },
            en: {
                // UI Strings
                TITLE: 'CV Generator (ATS)',
                SUBTITLE: 'Smart ATS optimization and document merging.',
                LABEL_LANG_SELECT: 'Language:',
                LABEL_UPLOAD: '1. Current CV (PDF)',
                FILENAME_PLACEHOLDER: 'Select file...',
                LABEL_JOB_DESC: '2. Job Description',
                JOB_DESC_PLACEHOLDER: 'Paste job description here...',
                LABEL_ANNEX_PAGE: '3. Annex Settings',
                SMALL_ANNEX_DESC: '(E.g. If new CV is 2 pages, annexes start on page 3).',
                BTN_COMBINE: 'GENERATE AND ADAPT CV',
                BTN_CV_DOWNLOAD: 'üì• Download Optimized CV',
                BTN_LETTER_DOWNLOAD: 'üìù Download Cover Letter',
                STATUS_COMPLETE: 'Process finished. Your documents are ready.',
                STATUS_INCOMPLETE: '‚ö†Ô∏è Please upload CV and Job Description.',
                STATUS_VALIDATE_PAGE: '‚ö†Ô∏è Invalid page number.',
                STATUS_READING: 'Analyzing PDF document...',
                STATUS_THINKING: 'AI is writing and optimizing your profile...',

                // PDF/AI Strings
                CV_TITLE: 'Curriculum Vitae (CV)',
                EXP_TITLE: 'PROFESSIONAL EXPERIENCE',
                SKILLS_TITLE: 'SKILLS',
                EDU_TITLE: 'EDUCATION',
                PERSONAL_TITLE: 'PERSONAL DATA',
                FIELD_CONTACTO: 'Contact',
                FIELD_NACIONALIDAD: 'Nationality',
                FIELD_ESTADO_CIVIL: 'Marital Status',
                FIELD_FECHA_NACIMIENTO: 'Date of Birth',
                FIELD_LUGAR_NACIMIENTO: 'Place of Birth',
                FIELD_DIRECCION: 'Address',
                LETTER_SUBJECT: 'Application for the position of',
                LETTER_CLOSING_SALUTATION: 'Sincerely,',
                LETTER_CLOSING_BODY: 'Thank you for your time and consideration. I attach my CV for your thorough review and eagerly anticipate the opportunity to discuss my application further.',
                LETTER_GENERIC_SALUTATION: 'Dear Hiring Manager,',
                LETTER_GENERIC_TEAM: 'Human Resources Team at',
                COUNTRY_RESIDENCE: 'Country of Residence',
            },
            de: {
                // UI Strings
                TITLE: 'Lebenslauf Generator (ATS)',
                SUBTITLE: 'Intelligente ATS-Optimierung und Dokumentenzusammenf√ºhrung.',
                LABEL_LANG_SELECT: 'Sprache:',
                LABEL_UPLOAD: '1. Aktueller Lebenslauf (PDF)',
                FILENAME_PLACEHOLDER: 'Datei ausw√§hlen...',
                LABEL_JOB_DESC: '2. Stellenbeschreibung',
                JOB_DESC_PLACEHOLDER: 'Stellenbeschreibung hier einf√ºgen...',
                LABEL_ANNEX_PAGE: '3. Anhang-Einstellungen',
                SMALL_ANNEX_DESC: '(z.B. Wenn neuer CV 2 Seiten hat, beginnen Anh√§nge auf Seite 3).',
                BTN_COMBINE: 'CV GENERIEREN & ANPASSEN',
                BTN_CV_DOWNLOAD: 'üì• Optimierten CV laden',
                BTN_LETTER_DOWNLOAD: 'üìù Anschreiben laden',
                STATUS_COMPLETE: 'Vorgang abgeschlossen. Ihre Dokumente sind bereit.',
                STATUS_INCOMPLETE: '‚ö†Ô∏è Bitte CV und Stellenbeschreibung hochladen.',
                STATUS_VALIDATE_PAGE: '‚ö†Ô∏è Ung√ºltige Seitenzahl.',
                STATUS_READING: 'PDF wird analysiert...',
                STATUS_THINKING: 'KI schreibt und optimiert Ihr Profil...',

                // PDF/AI Strings
                CV_TITLE: 'Lebenslauf (CV)',
                EXP_TITLE: 'BERUFSERFAHRUNG',
                SKILLS_TITLE: 'F√ÑHIGKEITEN',
                EDU_TITLE: 'AUSBILDUNG',
                PERSONAL_TITLE: 'PERS√ñNLICHE DATEN',
                FIELD_CONTACTO: 'Kontakt',
                FIELD_NACIONALIDAD: 'Nationalit√§t',
                FIELD_ESTADO_CIVIL: 'Familienstand',
                FIELD_FECHA_NACIMIENTO: 'Geburtsdatum',
                FIELD_LUGAR_NACIMIENTO: 'Geburtsort',
                FIELD_DIRECCION: 'Adresse',
                LETTER_SUBJECT: 'Bewerbung f√ºr die Position als',
                LETTER_CLOSING_SALUTATION: 'Mit freundlichen Gr√º√üen,',
                LETTER_CLOSING_BODY: 'Ich danke Ihnen f√ºr Ihre Zeit und Ihr Engagement. Meinen Lebenslauf f√ºge ich zur Einsicht bei und freue mich auf die Gelegenheit, meine Bewerbung in einem pers√∂nlichen Gespr√§ch zu vertiefen.',
                LETTER_GENERIC_SALUTATION: 'Sehr geehrte Damen und Herren,',
                LETTER_GENERIC_TEAM: 'Personalabteilung von',
                COUNTRY_RESIDENCE: 'Wohnsitzland',
            },
            pt: {
                // UI Strings
                TITLE: 'Gerador de CV (ATS)',
                SUBTITLE: 'Otimiza√ß√£o ATS inteligente e fus√£o de documentos.',
                LABEL_LANG_SELECT: 'Idioma:',
                LABEL_UPLOAD: '1. Seu CV Atual (PDF)',
                FILENAME_PLACEHOLDER: 'Selecionar arquivo...',
                LABEL_JOB_DESC: '2. Descri√ß√£o da Vaga',
                JOB_DESC_PLACEHOLDER: 'Cole aqui o texto da oferta de emprego...',
                LABEL_ANNEX_PAGE: '3. Configura√ß√£o de Anexos',
                SMALL_ANNEX_DESC: '(Ex: Se o novo CV tiver 2 p√°ginas, os anexos come√ßam na p√°gina 3).',
                BTN_COMBINE: 'GERAR E ADAPTAR CV',
                BTN_CV_DOWNLOAD: 'üì• Baixar CV Otimizado',
                BTN_LETTER_DOWNLOAD: 'üìù Baixar Carta de Apresenta√ß√£o',
                STATUS_COMPLETE: 'Processo conclu√≠do. Seus documentos est√£o prontos.',
                STATUS_INCOMPLETE: '‚ö†Ô∏è Por favor, envie seu CV e a descri√ß√£o da vaga.',
                STATUS_VALIDATE_PAGE: '‚ö†Ô∏è N√∫mero de p√°gina inv√°lido.',
                STATUS_READING: 'Analisando documento PDF...',
                STATUS_THINKING: 'A IA est√° redigindo e otimizando seu perfil...',

                // PDF/AI Strings
                CV_TITLE: 'Curriculum Vitae (CV)',
                EXP_TITLE: 'EXPERI√äNCIA PROFISSIONAL',
                SKILLS_TITLE: 'COMPET√äNCIAS',
                EDU_TITLE: 'FORMA√á√ÉO',
                PERSONAL_TITLE: 'DADOS PESSOAIS',
                FIELD_CONTACTO: 'Contacto',
                FIELD_NACIONALIDAD: 'Nacionalidade',
                FIELD_ESTADO_CIVIL: 'Estado Civil',
                FIELD_FECHA_NACIMIENTO: 'Data de Nascimento',
                FIELD_LUGAR_NACIMIENTO: 'Naturalidade',
                FIELD_DIRECCION: 'Morada',
                LETTER_SUBJECT: 'Candidatura para o cargo de',
                LETTER_CLOSING_SALUTATION: 'Atenciosamente,',
                LETTER_CLOSING_BODY: 'Agrade√ßo o seu tempo e considera√ß√£o. Anexo o meu CV para sua an√°lise detalhada e aguardo com entusiasmo a oportunidade de discutir a minha candidatura.',
                LETTER_GENERIC_SALUTATION: 'Exmo(a). Senhor(a) Respons√°vel de Recrutamento,',
                LETTER_GENERIC_TEAM: 'Equipa de Recursos Humanos de',
                COUNTRY_RESIDENCE: 'Pa√≠s de Resid√™ncia',
            }
        };

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // --- FUNCI√ìN DE ACTUALIZACI√ìN DE INTERFAZ (i18n) ---
        function updateUI(lang) {
            const T = translations[lang];

            // T√≠tulos principales
            document.getElementById('mainTitle').innerText = T.TITLE;
            document.getElementById('subTitle').innerText = T.SUBTITLE;

            // Labels
            document.getElementById('labelUpload').innerText = T.LABEL_UPLOAD;
            document.getElementById('labelJobDesc').innerText = T.LABEL_JOB_DESC;
            document.getElementById('labelAnnexPage').innerText = T.LABEL_ANNEX_PAGE;
            document.getElementById('labelLangSelect').innerText = T.LABEL_LANG_SELECT;

            // Placeholders y Textos Peque√±os
            // Verificamos si hay archivo cargado para no sobrescribir el nombre
            const fileInput = document.getElementById('pdfInput');
            if (!fileInput.files[0]) {
                document.getElementById('fileName').innerText = T.FILENAME_PLACEHOLDER;
            }
            
            document.getElementById('jobDescription').placeholder = T.JOB_DESC_PLACEHOLDER;
            document.getElementById('smallAnnexDesc').innerText = T.SMALL_ANNEX_DESC;

            // Botones
            document.getElementById('combineBtn').innerText = T.BTN_COMBINE;
            document.getElementById('btnCVDownload').innerHTML = `<span>üì•</span> ${T.BTN_CV_DOWNLOAD}`;
            document.getElementById('btnLetterDownload').innerHTML = `<span>üìù</span> ${T.BTN_LETTER_DOWNLOAD}`;
        }

        function setLanguage(lang) {
            window.appLanguage = lang;
            document.querySelectorAll('.language-selector button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(`lang-${lang}`).classList.add('selected');
            updateUI(lang);
        }

        // Inicializar la interfaz al cargar
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(window.appLanguage);
        });

        function mostrarNombre() {
            const input = document.getElementById('pdfInput');
            if (input.files[0]) {
                document.getElementById('fileName').innerText = "‚úÖ " + input.files[0].name;
                document.getElementById('fileName').style.color = "#0f172a";
                document.getElementById('fileName').style.fontWeight = "600";
            }
        }

        // --- FUNCI√ìN DE GENERACI√ìN DE NOMBRE DE ARCHIVO ---
        function generateFilename(data, docType) {
            const company = data.destinatario.nombre_empresa || "EMPRESA";
            const fullName = data.nombre || "CANDIDATO";

            const now = new Date();
            const datePart = now.getFullYear().toString() +
                (now.getMonth() + 1).toString().padStart(2, '0') +
                now.getDate().toString().padStart(2, '0');

            const nameParts = fullName.trim().split(' ');
            const surname = nameParts.length > 1 ? nameParts[nameParts.length - 1] : nameParts[0];

            let filename = "";
            if (docType === 'CV') {
                filename = `${company}_${datePart}_CV_${surname}`;
            } else {
                filename = `${company}_${datePart}_CARTA_${surname}`;
            }

            return filename.toUpperCase().replace(/\s+/g, '_').replace(/[^A-Z0-9_]/g, '') + ".pdf";
        }

        async function combinarDocumentos() {
            const fileInput = document.getElementById('pdfInput');
            const jobDesc = document.getElementById('jobDescription').value;
            const btn = document.getElementById('combineBtn');
            const status = document.getElementById('status');
            const downloadArea = document.getElementById('downloadArea');
            const previewContainer = document.getElementById('previewContainer');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');

            const lang = window.appLanguage;
            const T = translations[lang];

            if (!fileInput.files[0] || jobDesc.length < 20) { status.innerText = T.STATUS_INCOMPLETE; return; }

            const annexStartPage = parseInt(document.getElementById('annexStartPage').value);
            if (isNaN(annexStartPage) || annexStartPage < 1) {
                status.innerText = T.STATUS_VALIDATE_PAGE;
                return;
            }

            // RESET UI
            btn.disabled = true;
            btn.style.opacity = "0.7";
            downloadArea.style.display = 'none';
            previewContainer.style.display = 'none';
            previewContainer.innerHTML = '';
            
            // INICIAR BARRA DE PROGRESO
            progressContainer.style.display = 'block';
            progressBar.style.width = '10%'; // Inicio
            status.innerText = T.STATUS_READING;

            try {
                const file = fileInput.files[0];
                const buffer = await file.arrayBuffer();

                originalPdfBuffer = buffer;

                const pdfData = await extraerTexto(file);
                
                // ACTUALIZAR PROGRESO (PDF LEIDO)
                progressBar.style.width = '40%'; 
                status.innerText = T.STATUS_THINKING;

                const jsonCV = await procesarConIA(pdfData.text, jobDesc, lang);
                finalCVData = jsonCV;

                // COMPLETAR PROGRESO
                progressBar.style.width = '100%';
                status.innerText = T.STATUS_COMPLETE;

                renderNewCVTemplate(jsonCV);

                setTimeout(() => {
                    previewContainer.style.display = 'block';
                    downloadArea.style.display = 'flex';
                    // Scroll suave hacia los botones
                    downloadArea.scrollIntoView({ behavior: 'smooth' });
                }, 500);

            } catch (error) {
                console.error(error);
                status.innerText = "‚ùå Error: " + error.message;
                progressBar.style.backgroundColor = '#ef4444'; // Rojo si hay error
            } finally {
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        }

        async function extraerTexto(file) {
            const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
            let fullText = "";
            const maxPagesToProcess = Math.min(pdf.numPages, 5);

            for (let i = 1; i <= maxPagesToProcess; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(' ') + "\n";
            }

            return { text: fullText, totalPages: pdf.numPages };
        }

        async function procesarConIA(cv, oferta, lang) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODELO}:generateContent?key=${API_KEY}`;

            const langInstruction = `Todo el contenido de los campos de texto debe ser escrito y traducido al idioma: ${lang === 'es' ? 'Espa√±ol' : lang === 'en' ? 'Ingl√©s' : lang === 'de' ? 'Alem√°n' : 'Portugu√©s'}.`;

            const prompt = `
            Act√∫a como un reclutador experto y redactor de CVs. Tu tarea es generar un CV adaptado y una Carta de Presentaci√≥n altamente persuasiva.
            ${langInstruction}

            CV ORIGINAL DEL USUARIO: ${cv}
            OFERTA DE TRABAJO OBJETIVO: ${oferta}

            INSTRUCCIONES DE SALIDA:
            1. Devuelve SOLAMENTE un objeto JSON que siga exactamente el esquema provisto.
            2. **EXTRACCI√ìN PERSONAL:** Extr√°e la Direcci√≥n, Estado Civil, Nacionalidad, Fecha y Lugar de Nacimiento del CV original. Si la informaci√≥n no se encuentra, devuelve "No encontrado" o la inferencia m√°s cercana.
            3. **CRUCIAL PARA LA CARTA:** Genera el cuerpo de la carta de presentaci√≥n (carta_cuerpo_adaptado) siguiendo estos criterios:
                a. Debe ser entusiasta y mostrar inter√©s genuino en la empresa.
                b. Debe comparar la experiencia del usuario con los requisitos del puesto.
                c. NO DEBES INVENTAR: Solo conecta las palabras clave y logros que el usuario ya tiene.

            ESQUEMA JSON (Output MUST be valid JSON):
            {
              "nombre": "Nombre y Apellido",
              "contacto": "Email | Tel√©fono | LinkedIn",
              "pais_usuario": "Pa√≠s inferido del contacto o CV (ej: Venezuela)",
              "perfil_adaptado": "Resumen profesional reescrito para la oferta (M√°ximo 3 l√≠neas).",
              "experiencia_laboral": [
                {
                  "cargo": "T√≠tulo del puesto",
                  "empresa": "Nombre de la empresa",
                  "fechas": "Fechas de inicio/fin",
                  "logros_adaptados": ["Logro clave reescrito con keywords de la oferta."]
                }
              ],
              "educacion": "Detalle de educaci√≥n (mantenido del original).",
              "habilidades_adaptadas": ["Skill 1 (relevante)", "Skill 2 (relevante)"],
              "datos_personales": {
                "fecha_nacimiento": "DD.MM.YYYY (o No encontrado)",
                "lugar_nacimiento": "Ciudad, Pa√≠s (o No encontrado)",
                "nacionalidad": "Nacionalidad extra√≠da (o No encontrado)",
                "estado_civil": "Estado Civil (o No encontrado)",
                "direccion": "Direcci√≥n completa (o No encontrado)"
              },
              "destinatario": {
                "nombre_contacto": "Nombre y Apellido del reclutador (o Equipo de RRHH)",
                "puesto_solicitado": "T√≠tulo del puesto extra√≠do de la oferta",
                "nombre_empresa": "Nombre de la empresa objetivo",
                "ciudad_empresa": "Ciudad de la empresa (o el pa√≠s, si la ciudad no es clara)"
              },
              "carta_cuerpo_adaptado": "Texto completo y persuasivo de la carta de presentaci√≥n, dividido en p√°rrafos con saltos de l√≠nea (\\n) seg√∫n las instrucciones del usuario."
            }
        `;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message || "Error desconocido. Revisa si el contenido del CV es muy largo.");

            let jsonText = data.candidates[0].content.parts[0].text.trim();
            if (jsonText.startsWith('```')) {
                jsonText = jsonText.replace(/```json\n?|```/g, '');
            }

            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Error de parseo JSON:", jsonText);
                throw new Error("La IA no pudo devolver el formato JSON v√°lido. Intenta simplificar el CV o la Oferta de Trabajo.");
            }
        }

        function renderNewCVTemplate(data) {
            const previewContainer = document.getElementById('previewContainer');

            let textPreview = `
--- DATOS EXTRA√çDOS (PREVIEW) ---

NOMBRE: ${data.nombre || 'No encontrado'}
CONTACTO: ${data.contacto || 'No encontrado'}

--- CARTA DE PRESENTACI√ìN (Extracto) ---
${data.carta_cuerpo_adaptado ? data.carta_cuerpo_adaptado.substring(0, 150) + '...' : 'No disponible'}

--- EXPERIENCIA (Extracto) ---
`;

            if (Array.isArray(data.experiencia_laboral) && data.experiencia_laboral.length > 0) {
                textPreview += `${data.experiencia_laboral[0].cargo} en ${data.experiencia_laboral[0].empresa}...`;
            }

            previewContainer.innerHTML = `<pre>${textPreview}</pre>`;
        }

        // --- L√ìGICA DE GENERACI√ìN DE PDF ---

        const writeSection = (doc, title, content, cursorY, fontSize, style = 'normal', indent = 0, requiredTextWidth) => {
            const margin = LEFT_MARGIN;
            const effectiveTextWidth = requiredTextWidth;


            if (!content && title !== "CONTACTO") return cursorY;

            if (cursorY > doc.internal.pageSize.height - 30) {
                doc.addPage();
                cursorY = 15;
            }

            if (title && title !== "CONTACTO") {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(title.toUpperCase(), margin, cursorY);
                cursorY += 2;
                doc.line(margin, cursorY, doc.internal.pageSize.width - LEFT_MARGIN, cursorY);
                cursorY += 5;
            }

            doc.setFontSize(fontSize);
            doc.setFont(undefined, style);

            if (typeof content === 'string' && content) {
                const lines = doc.splitTextToSize(content, effectiveTextWidth - indent);
                lines.forEach(line => {
                    if (cursorY > doc.internal.pageSize.height - 10) {
                        doc.addPage();
                        cursorY = 15;
                    }
                    doc.text(line, margin + indent, cursorY);
                    cursorY += 5;
                });
            } else if (Array.isArray(content)) {
                content.forEach(item => {
                    const isExperience = (typeof item === 'object' && item.logros_adaptados);

                    if (isExperience) {
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        const titleLine = `${item.cargo} en ${item.empresa} (${item.fechas})`;
                        doc.text(titleLine, margin, cursorY);
                        cursorY += 5;

                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        const achievementText = item.logros_adaptados.map(l => `‚Ä¢ ${l}`).join('\n');
                        const achievementLines = doc.splitTextToSize(achievementText, effectiveTextWidth - 5);

                        achievementLines.forEach(line => {
                            if (cursorY > doc.internal.pageSize.height - 10) {
                                doc.addPage();
                                cursorY = 15;
                            }
                            doc.text(line, margin + 5, cursorY);
                            cursorY += 5;
                        });
                        cursorY += 3;

                    } else {
                        const lines = doc.splitTextToSize(item, effectiveTextWidth);
                        lines.forEach(line => {
                            if (cursorY > doc.internal.pageSize.height - 10) {
                                doc.addPage();
                                cursorY = 15;
                            }
                            doc.text(line, margin, cursorY);
                            cursorY += 5;
                        });
                        cursorY += 2;
                    }
                });
            }
            cursorY += 5;
            return cursorY;
        };

        const writePersonalDataList = (doc, data, cursorY, T) => {
            const margin = LEFT_MARGIN;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');

            const details = [
                { label: T.FIELD_CONTACTO, value: data.contacto.replace(/\|/g, ' ‚Ä¢ ') },
                { label: T.FIELD_DIRECCION, value: data.datos_personales.direccion },
                { label: T.FIELD_NACIONALIDAD, value: data.datos_personales.nacionalidad },
                { label: T.FIELD_ESTADO_CIVIL, value: data.datos_personales.estado_civil },
                { label: T.FIELD_FECHA_NACIMIENTO, value: data.datos_personales.fecha_nacimiento },
                { label: T.FIELD_LUGAR_NACIMIENTO, value: data.datos_personales.lugar_nacimiento }
            ];

            details.forEach(detail => {
                if (detail.value && detail.value !== 'No encontrado') {
                    doc.setFont(undefined, 'bold');
                    doc.text(`${detail.label}:`, margin, cursorY);
                    doc.setFont(undefined, 'normal');
                    doc.text(detail.value, margin + 45, cursorY);
                    cursorY += 5;
                }
            });

            cursorY += 10;
            return cursorY;
        }

        // --- 1. FUNCI√ìN DE DESCARGA: CV (FUSI√ìN CON CONTROL DE P√ÅGINA) ---
        async function descargarCV() {
            if (!finalCVData || !originalPdfBuffer) {
                alert("Error: El contenido del CV o el archivo original no se han procesado. Intenta COMBINAR de nuevo.");
                return;
            }

            const annexStartPage = parseInt(document.getElementById('annexStartPage').value);

            const doc = new jsPDF();
            let cursorY = 15;
            const pageWidth = doc.internal.pageSize.width;
            const T = translations[window.appLanguage];

            // C√ÅLCULO DEL ANCHO PARA CV (30mm de margen derecho para seguridad anti-recorte)
            const CV_RIGHT_MARGIN = 30;
            const CV_TEXT_WIDTH = pageWidth - LEFT_MARGIN - CV_RIGHT_MARGIN;

            // --- GENERACI√ìN DEL CV DE TEXTO (P√ÅGINAS ATS) ---
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text(finalCVData.nombre || T.CV_TITLE, pageWidth / 2, cursorY, { align: 'center' });
            cursorY += 15;

            cursorY = writeSection(doc, T.PERSONAL_TITLE, null, cursorY, 10, 'normal', 0, CV_TEXT_WIDTH);
            cursorY = writePersonalDataList(doc, finalCVData, cursorY, T);

            cursorY = writeSection(doc, T.EXP_TITLE, finalCVData.experiencia_laboral, cursorY, 10, 'normal', 0, CV_TEXT_WIDTH);
            cursorY = writeSection(doc, T.SKILLS_TITLE, finalCVData.habilidades_adaptadas.join(' | '), cursorY, 10, 'normal', 0, CV_TEXT_WIDTH);
            cursorY = writeSection(doc, T.EDU_TITLE, finalCVData.educacion, cursorY, 10, 'normal', 0, CV_TEXT_WIDTH);

            // -----------------------------------------------------
            // --- FUSI√ìN DE PDFS (COPIA SELECTIVA DE ANEXOS) ---
            // -----------------------------------------------------

            const newDocBytes = doc.output('arraybuffer'); // Obtener el CV de texto como buffer
            const finalPdf = await PDFDocument.create(); // Crear el documento final

            // 1. A√±adir p√°ginas del CV de texto
            const textPdf = await PDFDocument.load(newDocBytes);
            const copiedTextPages = await finalPdf.copyPages(textPdf, textPdf.getPageIndices());
            copiedTextPages.forEach(page => finalPdf.addPage(page));

            // 2. A√±adir p√°ginas de Anexos (a partir de la p√°gina seleccionada)
            const originalPdf = await PDFDocument.load(originalPdfBuffer);
            const totalOriginalPages = originalPdf.getPageCount();

            const pagesToCopyIndices = [];

            // Copiar √≠ndices (0-based) desde la p√°gina de inicio seleccionada (1-based) hasta el final.
            if (annexStartPage <= totalOriginalPages) {
                for (let i = annexStartPage - 1; i < totalOriginalPages; i++) {
                    pagesToCopyIndices.push(i);
                }
            }

            if (pagesToCopyIndices.length > 0) {
                const copiedAnnexPages = await finalPdf.copyPages(originalPdf, pagesToCopyIndices);
                copiedAnnexPages.forEach(page => finalPdf.addPage(page));
            }

            // 3. Guardar el PDF fusionado
            const pdfBytes = await finalPdf.save();

            // Descargar el archivo
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);

            // ** APLICAR NOMBRE DE ARCHIVO PERSONALIZADO **
            link.download = generateFilename(finalCVData, 'CV');

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 2. FUNCI√ìN DE DESCARGA: CARTA DE PRESENTACI√ìN ---
        function descargarCartaPresentacion() {
            if (!finalCVData || !finalCVData.destinatario || !finalCVData.carta_cuerpo_adaptado) {
                alert("Error: El contenido del CV o la carta no se han procesado. Intenta COMBINAR de nuevo.");
                return;
            }

            const doc = new jsPDF();
            let cursorY = 20;
            const margin = LEFT_MARGIN;
            const pageWidth = doc.internal.pageSize.width;

            const data = finalCVData;
            const dest = data.destinatario;
            const T = translations[window.appLanguage];

            // C√ÅLCULO DEL ANCHO PARA CARTA (25mm de margen derecho)
            const LETTER_RIGHT_MARGIN = 25;
            const LETTER_TEXT_WIDTH = pageWidth - LEFT_MARGIN - LETTER_RIGHT_MARGIN;

            const contacto = dest.nombre_contacto && dest.nombre_contacto.toLowerCase().includes(T.LETTER_GENERIC_TEAM.toLowerCase().split(' ')[0])
                ? `${T.LETTER_GENERIC_SALUTATION} ${dest.nombre_empresa || ''},`
                : (dest.nombre_contacto && dest.nombre_contacto !== 'No encontrado'
                    ? `Estimado/a ${dest.nombre_contacto},`
                    : `${T.LETTER_GENERIC_SALUTATION} ${dest.nombre_empresa || 'la empresa'},`);

            const puesto = dest.puesto_solicitado && dest.puesto_solicitado !== 'No encontrado' ? dest.puesto_solicitado : T.LETTER_SUBJECT.split(' ').pop();
            const paisUsuario = data.pais_usuario && data.pais_usuario !== 'No encontrado' ? data.pais_usuario : T.COUNTRY_RESIDENCE;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(data.nombre || 'Tu Nombre', pageWidth - margin, cursorY, { align: 'right' });
            cursorY += 5;
            doc.text(data.contacto.replace(/\|/g, ' ‚Ä¢ ') || 'Tu Contacto', pageWidth - margin, cursorY, { align: 'right' });
            cursorY += 15;

            doc.setFont(undefined, 'bold');
            doc.text(dest.nombre_contacto || T.LETTER_GENERIC_TEAM, margin, cursorY);
            cursorY += 5;
            doc.setFont(undefined, 'normal');
            doc.text(`Departamento de ${puesto}` || 'Departamento de Contrataci√≥n', margin, cursorY);
            cursorY += 5;
            doc.text(dest.nombre_empresa || 'Empresa Objetivo', margin, cursorY);
            cursorY += 5;
            doc.text(dest.ciudad_empresa || 'Ciudad/Pa√≠s', margin, cursorY);
            cursorY += 10;

            const today = new Date().toLocaleDateString(window.appLanguage === 'es' ? 'es-ES' : window.appLanguage === 'de' ? 'de-DE' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.text(`${paisUsuario}, ${today}`, pageWidth - margin, cursorY, { align: 'right' });
            cursorY += 10;
            doc.setFont(undefined, 'bold');
            doc.text(`${T.LETTER_SUBJECT} ${puesto}`, margin, cursorY);
            cursorY += 10;

            doc.setFont(undefined, 'normal');
            doc.text(contacto, margin, cursorY);
            cursorY += 10;

            const letterBody = data.carta_cuerpo_adaptado;
            const paragraphs = letterBody.split('\n').filter(p => p.trim());

            paragraphs.forEach(paragraph => {
                cursorY = writeSection(doc, "", paragraph, cursorY, 10, 'normal', 0, LETTER_TEXT_WIDTH);
                cursorY += 3;
            });
            cursorY += 7;

            cursorY = writeSection(doc, "", T.LETTER_CLOSING_BODY, cursorY, 10, 'normal', 0, LETTER_TEXT_WIDTH);
            cursorY += 5;

            doc.text(T.LETTER_CLOSING_SALUTATION, margin, cursorY);
            cursorY += 10;
            doc.text(data.nombre || 'Tu Nombre', margin, cursorY);

            const filename = generateFilename(finalCVData, 'CARTA');
            doc.save(filename);
        }
    </script>

</body>
</html>
